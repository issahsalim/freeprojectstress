{% extends 'base.html' %}
{%block title %} {{ project_details.name }} | Project Details {%endblock%}

{%block content %}

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }

    .card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        max-width: 1000px;
        width: 100%;
        margin: 0 auto;
    }

    .card-header {
        background: linear-gradient(45deg, #00b4db, #0083b0);
        padding: 30px;
        color: white;
        text-align: center;
        position: relative;
    }

    .card-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #00b4db, #0083b0, #00b4db);
    }

    .title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .desc {
        font-size: 18px;
        opacity: 0.9;
        line-height: 1.6;
    }

    .card-body {
        padding: 30px;
    }

    .section-title {
        font-size: 22px;
        font-weight: 600;
        margin: 25px 0 15px;
        color: #0083b0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        font-size: 24px;
    }

    /* Carousel Styles */
    .carousel-item img {
        max-height: 400px;
        object-fit: cover;
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
    }

    .btn {
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        border: none;
    }

    .btn-download {
        background: linear-gradient(45deg, #00b4db, #0083b0);
        color: white;
    }

    .btn-download:hover {
        background: linear-gradient(45deg, #0083b0, #00b4db);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-buy {
        background: linear-gradient(45deg, #00c853, #009624);
        color: white;
    }

    .btn-buy:hover {
        background: linear-gradient(45deg, #009624, #00c853);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .project-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .detail-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
    }

    .detail-card:hover {
        transform: translateY(-5px);
    }

    .detail-icon {
        font-size: 36px;
        color: #00b4db;
        margin-bottom: 15px;
    }

    .detail-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #0083b0;
    }

    .detail-value {
        font-size: 18px;
        font-weight: 500;
    }

    .tech-stack {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
    }

    .tech-pill {
        background: linear-gradient(45deg, #00b4db, #0083b0);
        color: white;
        padding: 8px 15px;
        border-radius: 50px;
        font-size: 14px;
        transition: transform 0.3s ease;
    }

    .tech-pill:hover {
        transform: scale(1.05);
    }

    /* Uploader Info Styles */
    .uploader-info {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 25px;
        margin: 30px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .uploader-info:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .uploader-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid #00b4db;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .uploader-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .uploader-details {
        flex-grow: 1;
    }

    .uploader-name {
        font-size: 20px;
        font-weight: 600;
        color: #0083b0;
        margin-bottom: 5px;
    }

    .uploader-contact {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #555;
    }

    .contact-item i {
        color: #00b4db;
    }

    .demo-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(45deg, #00b4db, #0083b0);
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 500;
        margin: 15px 0;
        transition: all 0.3s ease;
    }

    .demo-link:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .uploader-info {
            flex-direction: column;
            text-align: center;
        }

        .uploader-contact {
            justify-content: center;
        }

        .carousel {
            height: 250px;
        }
    }

    /* Spinner Styles */
    #spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .spinner {
        position: relative;
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .spinner::before,
    .spinner::after {
        border: 6.7px solid #474bff;
        border-radius: 50%;
        position: absolute;
        content: '';
        display: block;
    }

    .spinner::before {
        width: 33.6px;
        height: 33.6px;
        border-bottom-color: transparent;
        border-left-color: transparent;
        animation: spinner-1o3y8q 0.75s infinite linear reverse;
    }

    .spinner::after {
        animation: spinner-1o3y8q 0.5s infinite linear;
        height: 56px;
        width: 56px;
        border-right-color: transparent;
        border-top-color: transparent;
    }

    @keyframes spinner-1o3y8q {
        to {
            transform: rotate(360deg);
        }
    }

    .view-containers {
        display: none;
    }

    .show-downloaders {
        display: block;
    }
</style>

<div class="card">
    <div class="card-header">
        <h1 class="title">{{ project_details.name }}</h1>
        <p class="desc">{{ project_details.description }}</p>
    </div>

    <div id="spinner-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    {% if request.user.is_authenticated%}
    <div class="mt-3 text-center">
        {{total_download}} downlaods form your school <br />
        <div class="text-primary" id="viewdownloaders" style="cursor: pointer;">view them</div>

        <!-- Modal -->
        <div class="modal fade" id="downloadersModal" tabindex="-1" aria-labelledby="downloadersModalLabel"
            aria-hidden="true"> 
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="downloadersModalLabel">Downloaders Info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="downloaders-list">
                        {% for downloaders_info in downloaders %}
                        <h5><strong>Name:</strong> {% if request.user == downloaders_info.downloaders %} You {%else%} {{downloaders_info.downloaders}} {%endif%}</h5>
                        <p><strong>Contact:</strong> {{ downloaders_info.downloaders.phone }}</p>
                        <p><small>Date:</small> {{ downloaders_info.date }}</p>
                        <hr>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div> 
    {%endif%} 
    <div class="card-body">
        <!-- Project Gallery Carousel -->
        {% if project_details.projectImage1 %}
        <h2 class="section-title text-center mb-4">
            <i class="fas fa-images"></i> Project Gallery
        </h2>

        <div id="projectGalleryCarousel" class="carousel slide" data-bs-ride="carousel">

            <!-- Indicators (dots below the carousel) -->
            <div class="carousel-indicators">
                {% if project_details.projectImage1 %}
                <button type="button" data-bs-target="#projectGalleryCarousel" data-bs-slide-to="0" class="active"
                    aria-current="true" aria-label="Image 1"></button>
                {% endif %}
                {% if project_details.projectImage2 %}
                <button type="button" data-bs-target="#projectGalleryCarousel" data-bs-slide-to="1"
                    aria-label="Image 2"></button>
                {% endif %}
                {% if project_details.projectImage3 %}
                <button type="button" data-bs-target="#projectGalleryCarousel" data-bs-slide-to="2"
                    aria-label="Image 3"></button>
                {% endif %}
            </div>

            <!-- Carousel items -->
            <div class="carousel-inner">
                {% if project_details.projectImage1 %}
                <div class="carousel-item active">
                    <img src="{{ project_details.projectImage1.url }}" class="d-block w-100 rounded shadow"
                        alt="Project Image 1">
                </div>
                {% endif %}
                {% if project_details.projectImage2 %}
                <div class="carousel-item">
                    <img src="{{ project_details.projectImage2.url }}" class="d-block w-100 rounded shadow"
                        alt="Project Image 2">
                </div>
                {% endif %}
                {% if project_details.projectImage3 %}
                <div class="carousel-item">
                    <img src="{{ project_details.projectImage3.url }}" class="d-block w-100 rounded shadow"
                        alt="Project Image 3">
                </div>
                {% endif %}
            </div>

            <!-- Controls -->
            <button class="carousel-control-prev" type="button" data-bs-target="#projectGalleryCarousel"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Previous</span>
            </button>

            <button class="carousel-control-next" type="button" data-bs-target="#projectGalleryCarousel"
                data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>

        {% else %}
        <div class="text-center fs-3 fw-bold">No Project Gallery</div>
        {% endif %}

        <!-- Project Details -->
        {% if project_details.tech_stack %}
        <h2 class="section-title"><i class="fas fa-info-circle"></i> Project Details</h2>
        <div class="project-details">
            <div class="detail-card">
                <div class="detail-title">Technology Stack</div>
                <div class="tech-stack">
                    <span class="tech-pill">{{ project_details.tech_stack }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Demo Link -->
        {% if project_details.demo_link %}
        <a href="{{project_details.demo_link}}" target="_blank" class="demo-link">
            <i class="fas fa-external-link-alt"></i> View Live Demo
        </a>
        {% endif %}

        <!-- Features -->
        {% if project_details.features %}
        <h2 class="section-title"><i class="fas fa-cogs"></i> Features</h2>
        <ul style="list-style: none; margin-left: 20px;">
            <li style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle" style="color: #00c853;"></i>{{project_details.features }}
            </li>
        </ul>
        {% endif %}

        <!-- Uploader Information -->
        <div class="uploader-info">
            <div class="uploader-avatar">
                {% if project_details.uploaded_by.profile_pic %}
                <img src="{{ project_details.uploaded_by.profile_pic }}" alt="Profile Picture">
                {% else %}
                <div class="uploader-avatar"
                    style="background: linear-gradient(45deg, #00b4db, #0083b0);color: white; font-size: 24px;">
                    <i class="fas fa-user"></i>
                </div> {% endif %}
            </div>
            <div class="uploader-details">
                <h3 class="uploader-name">{{ project_details.uploaded_by.get_full_name }}</h3>
                <p class="text-muted">Project Uploader</p>
                <div class="uploader-contact">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>{{ project_details.uploaded_by.phone }}</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ project_details.uploaded_by.email }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
         {% if request.user.is_authenticated%}
        <div class="action-buttons">
            {% if is_paid %}
            <a href="{{ project_details.file.url }}" download class="btn btn-download" id="download-btn">
                <i class="fas fa-download"></i> Download Project
            </a>
            {% else %}
            <button id="buy" class="btn btn-buy">
                <i class="fas fa-shopping-cart"></i> Buy Project (GHS {{ project_details.price }})
            </button>
            {%endif%}
        {%else%} 
            <a href="{% url 'auth' %}" class="btn btn-primary d-flex justify-content-center"> Login to download</a>
        </div>
        {%endif%}
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // viewing downlaoders 
        const downloadersModal = new bootstrap.Modal(document.getElementById("downloadersModal"));
        view_btn = document.getElementById("viewdownloaders")
        view_btn.addEventListener('click', () => {
            view_downlaoders = document.getElementById("downloaders-list")
            view_downlaoders.classList.toggle('show-downloaders')
            downloadersModal.show()

        })


        // Spinner functions
        function showSpinner() {
            document.getElementById('spinner-overlay').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('spinner-overlay').style.display = 'none';
        }

        // Payment functionality
        
        const buyBtn = document.getElementById('buy');
        if (buyBtn) { 
            buyBtn.addEventListener('click', () => {
                let handler = PaystackPop.setup({
                    key: "{{PAYSTACK_PUBLIC_KEY}}",
                    email: "{{request.user.email}}",
                    amount: {{ project_details.price }} * 100,
                currency: "GHS",
                ref: "{{transaction_id}}",
                callback: function (response) {
                    fetch(`/payment/verify/?reference=${response.reference}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === "success") {
                                window.location.reload()  
                              
                            //    setTimeout(() => {
                            //         showSpinner();
                            //         setTimeout(() => {
                            //             hideSpinner()
                            //             Swal.fire({
                            //                 title: 'Payment Successful!',
                            //                 text: 'Your payment has been processed successfully. You can now download the project.',
                            //                 icon: 'success',
                            //                 confirmButtonColor: '#3085d6'
                            //             }).then((result) => {
                            //                 if (result.isConfirmed) {
                            //                     buyBtn.outerHTML = ` 
                            //                             <a href="{{ project_details.file.url }}" download class="btn btn-download">
                            //                                 <i class="fas fa-download"></i> Download Project
                            //                             </a>
                            //                         `;
                            //                 }
                            //             });
                            //         }, 1000)
                            //     }, 0);
                         
                            
                            } else {
                                // Payment failed SweetAlert
                                Swal.fire({
                                    title: 'Payment Failed ❌',
                                    text: 'There was an issue processing your payment. Please try again.',
                                    icon: 'error',
                                    confirmButtonText: 'Try Again',
                                    confirmButtonColor: '#d33'
                                });
                            
                            } 
                        }) 
                        .catch(error => { 
                            // Network error SweetAlert 
                            Swal.fire({ 
                                title: 'Verification Error',
                                text: 'Unable to verify payment. Please try again or contact support.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#d33'
                            });
                        });
                },
                onClose: function () {
                    // Payment window closed SweetAlert
                    Swal.fire({
                        title: 'Payment Cancelled',
                        text: 'You closed the payment window. Your payment was not completed.',
                        icon: 'info',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6c757d'
                    });
                }
                });

    handler.openIframe();
            });
        }

    });
</script>

{%endblock%}