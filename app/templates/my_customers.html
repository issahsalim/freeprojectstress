{% extends 'base.html' %}

{% block title %}My Customers{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">My Customers</h1>
            <p class="text-muted">View details of users who purchased your projects {{project_info.name}}</p>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-primary me-3">{{ my_customers|length }} customer{{ my_customers|length|pluralize}}</span>
            <button class="btn btn-outline-secondary" id="exportPdfBtn">
                <i class="fas fa-download me-2"></i>Export PDF
            </button>
        </div>
    </div>

    {% if my_customers %}
    <div class="card shadow-sm" id="customerTable">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0">Customer List</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Customer</th>
                            <th>Contact Info</th>
                            <th>Purchase Date</th>
                            <!-- <th>Projects Owned</th>
                            <th class="text-center">Actions</th> -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in my_customers %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    {% if customer.bought_by.profile_pic%}
                                    <img src="{{ customer.bought_by.profile_pic.url }}" alt="Profile" width="32" height="32"
                                        class="rounded-circle me-2">
                                    {%else%}
                                    <div
                                        class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                                        <i class="fas fa-user text-primary"></i>
                                    </div>
                                    {%endif%}
                                    <div>
                                        <h6 class="mb-0">{{ customer.bought_by.username }}</h6>
                                        <small class="text-muted">Customer ID: {{ customer.bought_by.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if customer.bought_by.email %}
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    <small>{{ customer.bought_by.email }}</small>
                                </div>
                                {% endif %}
                                {% if customer.bought_by.phone %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-phone text-muted me-2"></i>
                                    <small>{{ customer.bought_by.phone }}</small>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ customer.payment_date }}</span>
                            </td>

                            <!-- <td>
                                <span class="badge bg-info bg-opacity-10 text-info">3 projects</span>
                            </td> -->

                            <!-- <td class="text-center">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Send Message">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td> -->

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alternative Card View (Toggleable) -->
    <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Card View</h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary active" id="tableViewBtn">
                    <i class="fas fa-table"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" id="cardViewBtn">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>

        <div class="row d-none" id="cardView">
            {% for customer in my_customers %}
            <div class="col-xl-4 col-lg-6 mb-4">
                <div class="card customer-card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center">
                                {% if customer.bought_by.profile_pic%}
                                <img src="{{ customer.bought_by.profile_pic.url }}" alt="Profile" width="32" height="32"
                            class="rounded-circle me-2">
                                {%else%}
                                <div
                                    class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                                    <i class="fas fa-user fa-lg text-primary"></i>
                                </div>
                                {%endif%}
                                <div>
                                    <h5 class="mb-0">{{ customer.bought_by.username }}</h5>
                                    <small class="text-muted">Joined {{ customer.payment_date }}</small>
                                </div>
                            </div>
                            <!-- <span class="badge bg-primary">Active</span> -->
                        </div>

                        <div class="customer-info mb-3">
                            {% if customer.bought_by.phone %} 
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <small>{{ customer.bought_by.phone }}</small>
                            </div>
                            {% endif %}

                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-calendar text-muted me-2"></i>
                                <small>Purchased on {{ customer.payment_date }}</small>
                            </div>

                            <!-- <div class="d-flex align-items-center">
                                <i class="fas fa-box text-muted me-2"></i>
                                <small>Owns 3 of your projects</small>
                            </div> -->
                        </div>

                        <!-- <div class="d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i> Details
                            </button>
                            <button class="btn btn-sm btn-outline-success">
                                <i class="fas fa-envelope me-1"></i> Message
                            </button>
                        </div> -->
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="empty-state">
            <i class="fas fa-users fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Customers Yet</h3>
            <p class="text-muted mb-4">You don't have any customers yet. Promote your projects to attract buyers.</p>
            <a href="{% url 'project_page' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Projects
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include required libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Toggle between table and card view
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardViewBtn = document.getElementById('cardViewBtn');
        const cardView = document.getElementById('cardView');
        const tableView = document.querySelector('.table-responsive').closest('.card');

        cardViewBtn.addEventListener('click', function () {
            tableView.classList.add('d-none');
            cardView.classList.remove('d-none');
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
        });

        tableViewBtn.addEventListener('click', function () {
            cardView.classList.add('d-none');
            tableView.classList.remove('d-none');
            cardViewBtn.classList.remove('active');
            tableViewBtn.classList.add('active');
        });

        // PDF Export functionality
        const exportPdfBtn = document.getElementById('exportPdfBtn');

        exportPdfBtn.addEventListener('click', function () {
            // Show loading state
            const originalText = exportPdfBtn.innerHTML;
            exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
            exportPdfBtn.disabled = true;

            // Use html2canvas and jsPDF to generate PDF
            const { jsPDF } = window.jspdf;

            // Get the current date for the report
            const currentDate = new Date().toLocaleDateString();

            // Create a temporary container for PDF content
            const pdfContainer = document.createElement('div');
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            pdfContainer.style.width = '800px';
            pdfContainer.style.padding = '20px';
            pdfContainer.style.backgroundColor = 'white';
            document.body.appendChild(pdfContainer);

            // Create PDF header
            const header = `
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">
                <h1 style="color: #0d6efd; margin: 0;">Customer Report {{project_info.name}}</h1>
                <p style="margin: 5px 0; color: #6c757d;">Generated on ${currentDate}</p>
                <p style="margin: 0; color: #6c757d;">Total Customers: {{ my_customers|length }}</p>
            </div>
        `;

            pdfContainer.innerHTML = header;

            // Always create a table for PDF export (regardless of current view)
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '20px';
            table.style.fontFamily = 'Arial, sans-serif';

            // Create table header
            const thead = document.createElement('thead');
            thead.innerHTML = `
            <tr style="background-color: #f8f9fa;">
                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Customer</th>
                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Contact Info</th>
                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Purchase Date</th>
            </tr>
        `;
            table.appendChild(thead);

            // Create table body from customer data
            const tbody = document.createElement('tbody');

            // Get all customer data from Django template variables
            {% for customer in my_customers %}
            const row = document.createElement('tr');
            // Create contact info string
            let contactInfo = '';
            {% if customer.bought_by.email %}
            contactInfo += 'Email: {{ customer.bought_by.email }}';
            {% endif %}
            {% if customer.bought_by.phone %}
            {% if customer.bought_by.email %} contactInfo += '<br>'{% endif %}
            contactInfo += 'Phone: {{ customer.bought_by.phone }}';
            {% endif %}
            if (!contactInfo) contactInfo = 'No contact info';

            row.innerHTML = `
                <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <strong>{{ customer.bought_by.username }}</strong><br>
                    <small style="color: #6c757d;">Customer ID: {{ customer.bought_by.id }}</small>
                </td>
                <td style="border: 1px solid #dee2e6; padding: 12px;">${contactInfo}</td>
                <td style="border: 1px solid #dee2e6; padding: 12px;">{{ customer.payment_date }}</td>
            `;
            tbody.appendChild(row);
            {% endfor %}

            table.appendChild(tbody);
            pdfContainer.appendChild(table);

            // Add footer
            const footer = `
            <div style="margin-top: 30px; text-align: center; color: #6c757d; font-size: 12px;">
                <p>Confidential Customer Report - Generated by Project Management System</p>
            </div>
        `;
            pdfContainer.innerHTML += footer;

            // Use html2canvas to capture the content as an image
            html2canvas(pdfContainer, {
                scale: 2, // Higher quality
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 190; // A4 width in mm (with margins)
                const pageHeight = 280; // A4 height in mm (with margins)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10; // Start 10mm from top

                // Add first page
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add additional pages if content is too long
                while (heightLeft >= -pageHeight) {
                    position = heightLeft - imgHeight + 10;
                    if (position < -pageHeight) break;

                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Save the PDF
                pdf.save('customer_report_' + new Date().toISOString().slice(0, 10) + '.pdf');

                // Clean up
                document.body.removeChild(pdfContainer);

                // Restore button state
                exportPdfBtn.innerHTML = originalText;
                exportPdfBtn.disabled = false;

                // Show success message
                Swal.fire({
                    title: 'PDF Exported Successfully!',
                    text: 'Your customer report has been downloaded.',
                    icon: 'success',
                    confirmButtonColor: '#0d6efd',
                    timer: 3000
                });
            }).catch(error => {
                console.error('Error generating PDF:', error);

                // Clean up even on error
                if (pdfContainer.parentNode) {
                    document.body.removeChild(pdfContainer);
                }

                // Restore button state
                exportPdfBtn.innerHTML = originalText;
                exportPdfBtn.disabled = false;

                // Show error message
                Swal.fire({
                    title: 'Export Failed',
                    text: 'There was an error generating the PDF. Please try again.',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            });
        });
    });
</script>

<!-- SweetAlert for notifications -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
    .customer-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 10px;
    }

    .customer-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .avatar-sm {
        width: 40px;
        height: 40px;
    }

    .avatar-lg {
        width: 60px;
        height: 60px;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #6c757d;
    }

    .table td {
        vertical-align: middle;
    }

    .empty-state {
        max-width: 500px;
        margin: 0 auto;
    }

    .btn-group .btn.active {
        background-color: #0d6efd;
        color: white;
    }

    @media (max-width: 768px) {
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: flex-start !important;
        }

        .d-flex.align-items-center {
            margin-top: 1rem;
            width: 100%;
            justify-content: space-between;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .btn-group {
            flex-direction: column;
        }

        .btn-group .btn {
            margin-bottom: 0.25rem;
        }
    }

    /* Loading animation for PDF export button */
    .fa-spin {
        animation: fa-spin 1s infinite linear;
    }

    @keyframes fa-spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

{% endblock %}